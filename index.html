<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lessons</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Vue.js v2 -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>

  <!--Font Awesome Icons-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app">
    <header>
      <h1 v-text="sitename"></h1>

      <!-- Cart toggle button-->
      <button class="ghost" 
              v-on:click="toggleCheckoutPage"
              :disabled="cart.length === 0 && showProductPage" 
              aria-label="Toggle cart">
        <i class="fas fa-shopping-cart" aria-hidden="true"></i>
        Cart
        <span v-if="cart.length>0" class="cart-badge">{{ cart.length}}</span>
      </button>
    </header>

    <main class="container">
      <!-- Lessons / Products page -->
      <div v-if="showProductPage">
        <div class="controls">
          <div class="controls-left">
            <div class="controls-row">
              <div class="sort-label">Sort By:</div>
              <div class="radio-group">
                <label><input type="radio" v-model="sortKey" value="subject" /> Subject</label>
                <label><input type="radio" v-model="sortKey" value="location" /> Location</label>
                <label><input type="radio" v-model="sortKey" value="price" /> Price</label>
              </div>
            </div>

            <div class="controls-row">
              <div class="order-label">Order:</div>
              <div class="radio-group" role="radiogroup" aria-label="Sort order">
                <label><input type="radio" v-model="sortDir" value="asc" /> Ascending</label>
                <label><input type="radio" v-model="sortDir" value="desc" /> Descending</label>
              </div>
            </div>

            <!-- Search input --> 
             <div class = "controls-row search-row">
              <label for="search" class="sort-label" style="margin-right: 8px;">Search:</label>
              <input id="search"
                  class="search-input"
                  type="search"
                  v-model.trim="searchQuery"
                  placeholder="Type the lesson you want to enroll in"
                  aria-label="Search lesson by subject">
             </div>
          </div>
          
          <div class="total-lessons">Total Lessons: {{ lessons.length }}</div>
        </div>  
      
      <!--Displaying multiple lessons -->  
      <section class="lessons" aria-live="polite">  
        <article class="card" v-for="lesson in sortedLessons" :key="lesson.id">  
          <!--lesson image-->
          <div class="thumbnail" aria-hidden="true" v-if="lesson.image">
            <img :src="lesson.image" :alt="lesson.subject + ' thumbnail'">
          </div>
          
          <div class="card-header">
            <div>
              <h2 class="lesson-title">{{ lesson.subject }}</h2> 
              <!--blank space kept between title & location--> 
              <div class="lesson-spacer" aria-hidden="true"></div>
              <div class="lesson-line">  
                <div class="lesson-meta">
                  <div class="lesson-location">Location: {{ lesson.location }}</div>  
                </div>
              </div>
            </div>

            <div class="card-spaces">
              <div class="small">Spaces</div>
              <div class="price">{{ remainingSpaces(lesson) }}</div>
            </div>
          </div>

          <!--Ratings-->
          <div class="rating" aria-label="Rating">  
              <i v-for="i in 5"  
                 :key="i"  
                 :class="(i <= (lesson.rating || 0)) ? 'fas fa-star filled' : 'far fa-star empty'"  
                 aria-hidden="true"></i>  
              <span class="rating-label">({{ lesson.rating || 0 }})</span>  
          </div>

          <!--Add button-->
          <div class="card-actions">  
              <button class="primary" :disabled="!canAddToCart(lesson)" v-on:click="addToCart(lesson)">  
                <i class="fas fa-cart-plus" aria-hidden="true"></i>  
                Add to cart  
              </button>  
          </div>

          <!--Book Now note-->
          <div class="small card-note">Book now</div>

          <!--footer witht the price anchored at the bottom right-->
          <div class="card-footer">
            <div></div>
            <div class="lesson-price">${{ lesson.price }}</div>
          </div>
        </article>  
      </section>  
    </div>

      <!--Cart/Checkout page-->
      <div v-else class="cart-page">
        <h2>Cart</h2>
        <!--Message for empty cart-->
        <div v-if="cart.length === 0" class="small empty-cart-msg">
          Your cart is empty.
          <div class="mt-8">
            <button class="ghost" @click="toggleCheckoutPage">Back to lessons</button>
          </div>
        </div>

        <div v-else>
          <!--Display cart items with quantity-->
          <div class="cart-item" v-for="(qty, id) in cartSummary" :key="id">
            <div class="cart-item-left">
              <strong>{{  lessonById(id).subject  }}</strong>
              <div class="small">{{ lessonById(id).location }} - ${{ lessonById(id).price  }}</div>
              <div class="small">Quantity:  {{ qty }}</div>
            </div>

            <div class="cart-item-right">  
              <div class="mb-8">Total: ${{ lessonById(id).price * qty }}</div>  
              <button class="ghost" @click="removeOneFromCart(id)">Remove one</button>  
            </div>  
          </div>
          <!--Grand Total-->
          <div class="text-right mt-8">
            <div class="small">Grand total: <strong>${{ cartTotal }}</strong></div>
          </div>

          <hr />

          <!--Checkout form serction-->
          <h3>Checkout</h3>
          <div class="checkout-form">
            <div class="form-row">
              <label class="checkout-label">Name</label>
              <input type="text" v-model.trim="order.name" placeholder="Letters only" />
              <div class="small" v-if="order.name && !validName">Name must contain letters and spaces only.</div>
            </div>

            <div class="form-row">
              <label class="checkout-label">Phone</label>
              <input type="tel" v-model.trim="order.phone" placeholder="Numbers only" />
              <div class="small" v-if="order.phone && !validPhone">Phone must contain numbers only.</div>
            </div>

            <div class="form-row mt-8">
              <button class="primary" :disabled="!canCheckout" @click="checkoutSubmit">Checkout</button>
              <button class="ghost" @click="toggleCheckoutPage">Back to lessons</button>
            </div>
          </div>
        </div>
      </div>
    </main>  
  </div>

  <script src="lessons.js"></script>

  <script>
    //Cart Display logic
    var webstore = new Vue ({
      el: '#app',
      data: {
        sitename: 'Lessons',
        lessons: (typeof lessons !== 'undefined') ? lessons : [],
        cart: [],
        sortKey: 'subject',
        sortDir: 'asc',
        searchQuery: '',
        showProductPage: true,
        order: { name: '', phone: '' } //adding order object
      },
      created() {  
        //Checks if the lessons data is loaded  
        if (typeof lessons !== 'undefined' && Array.isArray(lessons) && lessons.length) {  
          this.lessons = lessons;  
        } else {  
          console.warn('lessons.js not found or empty');  
        }  
      },
      computed: {
        //Sorts the lessons 
        sortedLessons() {
          // filter by searchQuery
          const q = (this.searchQuery || '').trim().toLowerCase();
          let arr = this.lessons.slice();
          if (q)  {
            arr = arr.filter(l => {
              const s = (l.subject || '').toString().toLowerCase();
              return s.includes(q)
            });
          }

          const key = this.sortKey;
          const dir = this.sortDir === 'asc' ? 1 : -1;

          const getValue = (lesson) => {
            if (!lesson) return null;
            if (key === 'spaces') return this.remainingSpaces(lesson);
            return typeof lesson[key] !== 'undefined' ? lesson[key] : null;
          };

          arr.sort((a,b) =>  {
            const va = getValue(a);  
            const vb = getValue(b);
            
            //handle nulls
            if (va === null && vb === null) return 0;
            if (va === null) return 1 * dir;
            if (vb === null) return -1 * dir;

            //compare if both are numeric
            const aNum = Number(va);
            const bNum = Number(vb);
            const bothNumeric = !Number.isNaN(aNum) && !Number.isNaN(bNum);

            if (bothNumeric) {
              if (aNum > bNum) return 1 * dir;
              if (aNum < bNum) return -1 * dir;
              return 0;
            }

            //compare if string
            const sa = String(va).toLowerCase();
            const sb = String(vb).toLowerCase();
            return sa.localeCompare(sb) * dir;
          });
          return arr;
        },
        //summary of cart items by ID and quantity  
        cartSummary() {  
          const summary = {};  
          this.cart.forEach(id => { summary[id] = (summary[id] || 0) + 1; });  
          return summary;  
        },
        // Calculate total price of cart  
        cartTotal() {  
          return this.cart.reduce((sum, id) => {  
            const lesson = this.lessons.find(l => l.id === +id);  
            return sum + (lesson ? lesson.price : 0);  
          }, 0);  
        },
        //Checks for valid name input  
        validName() { return /^[A-Za-z ]+$/.test(this.order.name); },  
        //Checks for valid phone number input  
        validPhone() { return /^[0-9]+$/.test(this.order.phone); },  
        //Checks if checkout is allowed  
        canCheckout() { return this.validName && this.validPhone && this.cart.length > 0; }  
      },
      methods: {
        // Calculate remaining spaces for a lesson  
        remainingSpaces(lesson) {  
          const used = this.cartCount(lesson.id);  
          return Math.max(0, lesson.spaces - used);  
        },
        // Check if add to cart is possible  
        canAddToCart(lesson) {  
          return this.remainingSpaces(lesson) > 0;  
        },
        //Add lesson ID to cart if available
        addToCart(lesson) {
          if (this.canAddToCart(lesson)) this.cart.push(lesson.id);
        },
        //Counts how many times ID is in the cart
        cartCount(id) { return this.cart.filter(x => x  === id).length; },
        //Toggling between product and checkout pages
        toggleCheckoutPage(){
          this.showProductPage = !this.showProductPage;
        },
        //Get lesson by ID with fallback
        lessonById(id) { return this.lessons.find(l => l.id === +id) || { subject:'Unknown', location:'', price:0 }; },
        // Remove one instance of item from cart
        removeOneFromCart(id) {
          const idx = this.cart.indexOf(+id);
          if (idx !== -1) this.cart.splice(idx, 1);
        },
        //Submits order and resets
        checkoutSubmit() {  
          if (!this.canCheckout) return;  
          alert('Order submitted â€” Thank you!');  
          this.cart = [];  
          this.order = { name: '', phone: '' };  
          this.showProductPage = true;  
        },
      }
    });
  </script>
</body>
</html>